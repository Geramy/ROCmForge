---
phase: 13-03-dead-code-removal
plan: 02
type: execute
wave: 2
depends_on: ["01"]
files_modified:
  - src/backend/hip_backend/backend.rs
  - src/ggml/hip_backend/ops/quantized_matmul.rs
  - src/model/execution_plan/execution_plan_src.rs
  - src/ops/attention_gpu.rs
  - src/model/mod.rs
  - tests/common/fixtures.rs
  - tests/loader_tests.rs
autonomous: true

must_haves:
  truths:
    - "All 31 copy_to_host() deprecated warnings are resolved"
    - "All 3 ExecutionPlan::new() deprecated calls are replaced"
    - "Code uses HipBackend::copy_from_device_safe() instead of deprecated copy_to_host()"
    - "Test fixtures use ExecutionPlan::from_gguf() or alternative approach"
    - "cargo check shows zero deprecated method warnings"
  artifacts:
    - path: "src/backend/hip_backend/backend.rs"
      not_contains: ".copy_to_host("
      action: "all calls replaced"
    - path: "src/ggml/hip_backend/ops/quantized_matmul.rs"
      not_contains: ".copy_to_host("
      action: "all calls replaced"
    - path: "tests/common/fixtures.rs"
      not_contains: "ExecutionPlan::new("
      action: "uses from_gguf() or alternative approach"
  key_links:
    - from: "deprecated copy_to_host()"
      to: "HipBackend::copy_from_device_safe()"
      via: "method replacement"
      pattern: "copy_from_device_safe"
    - from: "deprecated ExecutionPlan::new()"
      to: "ExecutionPlan::from_gguf() or test fixture alternatives"
      via: "method call replacement or test restructuring"
      pattern: "from_gguf|create_mock_execution_plan"
---

<objective>
Replace all uses of deprecated methods with their recommended alternatives.

Purpose: Resolve 34 deprecated method warnings (31 copy_to_host + 3 ExecutionPlan::new) by migrating to the recommended replacement methods. This improves code clarity and removes compiler deprecation warnings.

Output: Zero deprecated method warnings, all code using current recommended APIs.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/13-03-dead-code-removal/13-03-CONTEXT.md
@.planning/phases/13-03-dead-code-removal/13-03-RESEARCH.md

# Source files with deprecated usage
@src/backend/hip_backend/backend.rs
@src/ggml/hip_backend/ops/quantized_matmul.rs
@src/model/execution_plan/execution_plan_src.rs
@src/ops/attention_gpu.rs
@src/model/mod.rs
@tests/common/fixtures.rs
@tests/loader_tests.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace all copy_to_host() calls with copy_from_device_safe()</name>
  <files>src/backend/hip_backend/backend.rs</files>
  <action>
    In src/backend/hip_backend/backend.rs, replace ALL calls to `.copy_to_host()` with `backend.copy_from_device_safe()`.

    The deprecated pattern is:
    ```rust
    buffer.copy_to_host(&mut host_data)?;
    ```

    Replace with:
    ```rust
    backend.copy_from_device_safe(&buffer, &mut host_data)?;
    ```

    This requires the method to have access to `backend` reference. If `backend` is not in scope, add it as a parameter or use the appropriate backend reference available in the context.

    First, identify all copy_to_host usages:
    ```bash
    grep -n "copy_to_host" src/backend/hip_backend/backend.rs
    ```

    Then replace each one systematically.

    Commit message: "refactor(13-03-02): replace deprecated copy_to_host with copy_from_device_safe in backend.rs"
  </action>
  <verify>cargo check --all-targets 2>&1 | grep "deprecated.*copy_to_host.*backend.rs" | wc -l (should be 0)</verify>
  <done>All copy_to_host calls in backend.rs replaced with copy_from_device_safe</done>
</task>

<task type="auto">
  <name>Task 2: Replace copy_to_host calls in quantized_matmul.rs</name>
  <files>src/ggml/hip_backend/ops/quantized_matmul.rs</files>
  <action>
    In src/ggml/hip_backend/ops/quantized_matmul.rs, replace ALL `.copy_to_host()` calls with `backend.copy_from_device_safe()`.

    Same pattern as Task 1 - replace deprecated buffer method with backend method.

    If `backend` is not available in scope, you may need to:
    1. Add `backend: &HipBackend` as a parameter to the function
    2. Or use `self.backend` if in an impl method
    3. Or use the appropriate backend reference available in context

    Commit message: "refactor(13-03-02): replace deprecated copy_to_host with copy_from_device_safe in quantized_matmul.rs"
  </action>
  <verify>cargo check --all-targets 2>&1 | grep "deprecated.*copy_to_host.*quantized_matmul.rs" | wc -l (should be 0)</verify>
  <done>All copy_to_host calls in quantized_matmul.rs replaced</done>
</task>

<task type="auto">
  <name>Task 3: Replace remaining copy_to_host calls in other source files</name>
  <files>src/model/execution_plan/execution_plan_src.rs src/ops/attention_gpu.rs src/model/mod.rs</files>
  <action>
    In src/model/execution_plan/execution_plan_src.rs, src/ops/attention_gpu.rs, and src/model/mod.rs, replace ALL `.copy_to_host()` calls with `backend.copy_from_device_safe()`.

    First, find all occurrences:
    ```bash
    grep -n "copy_to_host" src/model/execution_plan/execution_plan_src.rs src/ops/attention_gpu.rs src/model/mod.rs
    ```

    Then systematically replace each one, ensuring backend reference is available.

    Commit message: "refactor(13-03-02): replace remaining copy_to_host calls in model and ops modules"
  </action>
  <verify>cargo check --all-targets 2>&1 | grep "deprecated.*copy_to_host" | wc -l (should be 0 for src/ files)</verify>
  <done>All copy_to_host calls in src/ directory replaced</done>
</task>

<task type="auto">
  <name>Task 4: Replace ExecutionPlan::new calls in tests</name>
  <files>tests/common/fixtures.rs tests/loader_tests.rs</files>
  <action>
    In test files, replace deprecated `ExecutionPlan::new()` calls.

    First, find all occurrences:
    ```bash
    grep -n "ExecutionPlan::new" tests/common/fixtures.rs tests/loader_tests.rs
    ```

    The deprecated pattern requires `(backend, config)` parameters:
    ```rust
    let plan = ExecutionPlan::new(backend, config)?;
    ```

    The replacement `from_gguf()` requires `(backend, &metadata, tensor_loader)`.

    **Approach for tests that don't have metadata/tensor_loader:**

    1. **If the test has access to GGUF file data**: Use `ExecutionPlan::from_gguf()` by loading the metadata and tensor loader from a real GGUF file. See tests/common/fixtures.rs for existing GGUF loading helpers.

    2. **If the test is mocking/stubbing and doesn't need a real ExecutionPlan**: Replace with a minimal mock struct or use builder pattern. Create a helper like:
       ```rust
       #[cfg(test)]
       fn create_mock_execution_plan(backend: &HipBackend) -> ExecutionPlan {
           // Use from_gguf with minimal test GGUF data
           // Or create a minimal ExecutionPlan directly if possible
       }
       ```

    3. **If the test is testing internal ExecutionPlan behavior**: Restructure to test through the actual GGUF loading path, or mark the test as `#[ignore]` if it's testing deprecated functionality.

    Step 1: Read the test file to understand what the test is actually testing
    Step 2: Check if from_gguf() can be used with existing test fixtures
    Step 3: If not, create a new test fixture helper that provides a minimal ExecutionPlan
    Step 4: Update the test to use the new approach

    Commit message: "refactor(13-03-02): replace deprecated ExecutionPlan::new with from_gguf or test alternatives"
  </action>
  <verify>cargo check --all-targets 2>&1 | grep "deprecated.*ExecutionPlan::new" | wc -l (should be 0)</verify>
  <done>All ExecutionPlan::new calls replaced with from_gguf or test alternatives</done>
</task>

</tasks>

<verification>
After all tasks complete, verify:
1. cargo check --all-targets shows zero deprecated method warnings
2. grep -rn "copy_to_host" src/ tests/ (should only find the method definition, not calls)
3. grep -rn "ExecutionPlan::new(" src/ tests/ (should only find the deprecated definition, not calls)
4. Full test suite passes: cargo test --all-targets
</verification>

<success_criteria>
- 31 copy_to_host deprecated warnings resolved
- 3 ExecutionPlan::new deprecated warnings resolved
- All code uses current recommended APIs
- No compilation errors
- All tests passing
</success_criteria>

<output>
After completion, create `.planning/phases/13-03-dead-code-removal/13-03-02-SUMMARY.md`
</output>
